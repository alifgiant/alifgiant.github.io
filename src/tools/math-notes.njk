---
layout: layouts/base.njk
title: Math Notes
permalink: /tools/math-notes/
---

{# mathjs for calculation #}
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/11.8.0/math.js"></script>
{# html2canvas for image export #}
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

<div class="w-full max-w-5xl flex flex-col gap-12" x-data="mathNotes()" @keydown.window.escape="exitFullscreen()">
    {# Header #}
    {% set tool = {} %}
    {% for item in site.pages.tools.list %}
        {% if item.url == "/tools/math-notes/" %}
            {% set tool = item %}
        {% endif %}
    {% endfor %}
    {% set cat = site.pages.tools.categories[tool.tag] %}
    
    <div class="flex flex-col gap-4">
        <div class="inline-flex items-center gap-2 px-3 py-1 rounded-full text-xs font-bold uppercase tracking-wider self-start border {{ cat.color }}">
            <span class="material-symbols-outlined text-sm">{{ cat.icon }}</span>
            {{ tool.tag }}
        </div>
        <div class="w-16 h-16 rounded-2xl {{ cat.lightColor }} flex items-center justify-center">
            <span class="material-symbols-outlined text-4xl">{{ tool.icon }}</span>
        </div>
        <h1 class="text-4xl md:text-6xl font-bold text-text-main font-display">
            {{ tool.title }}
        </h1>
        <p class="text-lg text-text-muted max-w-2xl leading-relaxed">
            {{ tool.description }}
        </p>
    </div>

    {# Toolbar #}
    <div class="flex flex-wrap gap-4 items-center justify-between bg-stone-50 p-4 rounded-3xl border border-stone-100">
        <div class="flex flex-wrap gap-2">
            <button @click="clearAll()" class="px-6 py-2.5 rounded-full bg-white border border-stone-200 text-text-main font-medium hover:bg-stone-50 transition-all flex items-center gap-2">
                <span class="material-symbols-outlined text-xl">delete</span>
                Clear All
            </button>
            <div class="relative" x-data="{ open: false }" @click.away="open = false">
                    <button @click="open = !open" class="px-6 py-2.5 rounded-full bg-indigo-600 text-white font-medium hover:bg-indigo-700 transition-all flex items-center gap-2 shadow-sm">
                    <span class="material-symbols-outlined text-xl">download</span>
                    Export
                    <span class="material-symbols-outlined transition-transform duration-75" :class="open ? 'rotate-180' : ''" style="will-change: transform; backface-visibility: hidden;">expand_more</span>
                </button>
                <div x-show="open" 
                     x-transition:enter="transition ease-out duration-100"
                     x-transition:enter-start="opacity-0 scale-95"
                     x-transition:enter-end="opacity-100 scale-100"
                     class="absolute left-0 mt-2 w-56 bg-white rounded-2xl shadow-xl border border-stone-100 py-2 z-50">
                    <button @click="exportInputs(); open = false" class="w-full px-6 py-3 text-left hover:bg-stone-50 flex items-center gap-3 text-text-main">
                        <span class="material-symbols-outlined text-lg text-stone-400">text_snippet</span>
                        Inputs (.txt)
                    </button>
                    <button @click="exportResults(); open = false" class="w-full px-6 py-3 text-left hover:bg-stone-50 flex items-center gap-3 text-text-main">
                        <span class="material-symbols-outlined text-lg text-stone-400">equal</span>
                        Results (.txt)
                    </button>
                    <button @click="exportImage(); open = false" class="w-full px-6 py-3 text-left hover:bg-stone-50 flex items-center gap-3 text-text-main">
                        <span class="material-symbols-outlined text-lg text-stone-400">image</span>
                        Image (.png)
                    </button>
                </div>
            </div>
            <button
                @click="toggleFullscreen()"
                class="px-6 py-2.5 rounded-full border font-medium transition-all flex items-center gap-2 shadow-sm whitespace-nowrap"
                :class="isFullscreen ? 'bg-stone-900 text-white border-stone-900 hover:bg-stone-800' : 'bg-white border-stone-200 text-text-main hover:bg-stone-50'">
                <span class="material-symbols-outlined text-xl" x-text="isFullscreen ? 'fullscreen_exit' : 'fullscreen'"></span>
                <span x-text="isFullscreen ? 'Exit Fullscreen' : 'Fullscreen Mode'"></span>
            </button>
        </div>
        <div class="text-sm text-text-muted italic px-4">
            Supports variables, percentages, and units.
        </div>
    </div>

    <div
        x-show="isFullscreen"
        x-transition.opacity
        class="fixed inset-0 bg-[#020617]/80 backdrop-blur-sm z-40"
        @click="exitFullscreen()"
        aria-hidden="true"></div>

    {# Editor Container #}
    <div x-ref="editor" class="relative bg-[#1e1e1e] rounded-[2.5rem] border border-stone-800 shadow-2xl overflow-hidden min-h-[500px] flex" :class="isFullscreen ? 'fullscreen-editor' : ''">
        <button
            x-show="isFullscreen"
            x-transition
            @click.stop="exitFullscreen()"
            class="absolute top-6 right-6 z-50 inline-flex items-center gap-2 px-4 py-2 rounded-full bg-white/10 text-white border border-white/20 backdrop-blur hover:bg-white/20 transition-all">
            <span class="material-symbols-outlined text-lg">close</span>
            Exit Fullscreen
        </button>
        {# Input Area #}
        <div class="flex-1 relative">
            {# Syntax Highlighting Layer / Image Export Mirror #}
            <div x-ref="highlightLayer" 
                 class="math-input absolute inset-0 w-full h-full bg-transparent text-white font-mono overflow-hidden pointer-events-none whitespace-pre"
                 x-html="highlightedInput">
            </div>
            
            <textarea 
                x-ref="input"
                x-model="input" 
                @input="calculate()"
                @input.debounce.1000ms="saveToStorage()"
                @scroll="syncScroll()"
                spellcheck="false"
                wrap="off"
                class="math-input relative z-10 w-full h-full min-h-[500px] bg-transparent text-white/10 caret-white font-mono resize-none focus:outline-none border-none overflow-auto custom-scrollbar whitespace-pre"
                placeholder="Type your calculations here...
e.g. 100 + 20%
salary = 5000
tax = 15%
total tax = salary * tax"></textarea>
        </div>

        {# Divider line #}
        <div class="w-[1px] bg-stone-800"></div>

        {# Results Area #}
        <div 
            x-ref="results"
            class="math-results w-32 md:w-64 bg-[#1a1a1a] font-mono overflow-auto select-none custom-scrollbar relative"
            :style="isFullscreen ? resultsPaneStyles : ''">
            <template x-for="(res, index) in results" :key="index">
                <div class="math-line result-line" 
                     :class="{ 
                        'text-[#84cc16]': !res.isHeader, 
                        'text-indigo-400 font-bold': res.isHeader
                     }">
                     <span x-text="res.text"></span>
                </div>
            </template>
        </div>
    </div>

    {# Help / Tips #}
    {# Help / Tips Redesigned #}
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
        {# Group 1: Basics & Organization #}
        <div class="space-y-4">
            <div class="p-6 rounded-[2rem] bg-indigo-50/50 border border-indigo-100/50">
                <h3 class="text-sm font-bold text-indigo-900 mb-3 flex items-center gap-2">
                    <span class="material-symbols-outlined text-base">tag</span>
                    Structure
                </h3>
                <div class="space-y-2">
                    <div class="flex items-center justify-between text-[11px]">
                        <span class="text-indigo-800/60 font-medium">Header</span>
                        <code class="bg-indigo-100 px-1.5 py-0.5 rounded text-indigo-900 font-mono"># Project</code>
                    </div>
                    <div class="flex items-center justify-between text-[11px]">
                        <span class="text-indigo-800/60 font-medium">Comment</span>
                        <code class="bg-indigo-100 px-1.5 py-0.5 rounded text-indigo-900 font-mono">// description</code>
                    </div>
                    <div class="flex items-center justify-between text-[11px]">
                        <span class="text-indigo-800/60 font-medium">Label</span>
                        <code class="bg-indigo-100 px-1.5 py-0.5 rounded text-indigo-900 font-mono">Price: 100</code>
                    </div>
                </div>
            </div>

            <div class="p-6 rounded-[2rem] bg-emerald-50/50 border border-emerald-100/50">
                <h3 class="text-sm font-bold text-emerald-900 mb-3 flex items-center gap-2">
                    <span class="material-symbols-outlined text-base">data_object</span>
                    Variables
                </h3>
                <div class="space-y-2">
                    <div class="flex items-center justify-between text-[11px]">
                        <span class="text-emerald-800/60 font-medium">Assign</span>
                        <code class="bg-emerald-100 px-1.5 py-0.5 rounded text-emerald-900 font-mono">tax = 15%</code>
                    </div>
                    <div class="flex items-center justify-between text-[11px]">
                        <span class="text-emerald-800/60 font-medium">Reuse</span>
                        <code class="bg-emerald-100 px-1.5 py-0.5 rounded text-emerald-900 font-mono">price * tax</code>
                    </div>
                </div>
            </div>
        </div>

        {# Group 2: Math & Multiline #}
        <div class="space-y-4">
            <div class="p-6 rounded-[2rem] bg-amber-50/50 border border-amber-100/50">
                <h3 class="text-sm font-bold text-amber-900 mb-3 flex items-center gap-2">
                    <span class="material-symbols-outlined text-base">reorder</span>
                    Multiline
                </h3>
                <div class="space-y-2">
                    <div class="flex items-center justify-between text-[11px]">
                        <span class="text-amber-800/60 font-medium">Sum of above</span>
                        <code class="bg-amber-100 px-1.5 py-0.5 rounded text-amber-900 font-mono">sum</code>
                    </div>
                    <div class="flex items-center justify-between text-[11px]">
                        <span class="text-amber-800/60 font-medium">Average</span>
                        <code class="bg-amber-100 px-1.5 py-0.5 rounded text-amber-900 font-mono">avg</code>
                    </div>
                    <div class="flex items-center justify-between text-[11px]">
                        <span class="text-amber-800/60 font-medium">Last Result</span>
                        <code class="bg-amber-100 px-1.5 py-0.5 rounded text-amber-900 font-mono">prev</code>
                    </div>
                </div>
            </div>

            <div class="p-6 rounded-[2rem] bg-cyan-50/50 border border-cyan-100/50">
                <h3 class="text-sm font-bold text-cyan-900 mb-3 flex items-center gap-2">
                    <span class="material-symbols-outlined text-base">translate</span>
                    Natural Lang
                </h3>
                <div class="space-y-2">
                    <div class="flex items-center justify-between text-[11px]">
                        <span class="text-cyan-800/60 font-medium">Add/Sub</span>
                        <code class="bg-cyan-100 px-1.5 py-0.5 rounded text-cyan-900 font-mono">10 plus 5 minus 2</code>
                    </div>
                    <div class="flex items-center justify-between text-[11px]">
                        <span class="text-cyan-800/60 font-medium">Mul/Div</span>
                        <code class="bg-cyan-100 px-1.5 py-0.5 rounded text-cyan-900 font-mono">10 times 2 divided by 5</code>
                    </div>
                    <div class="flex items-center justify-between text-[11px]">
                        <span class="text-cyan-800/60 font-medium">Scales</span>
                        <code class="bg-cyan-100 px-1.5 py-0.5 rounded text-cyan-900 font-mono">1.2 million</code>
                    </div>
                    <div class="flex items-center justify-between text-[11px]">
                        <span class="text-cyan-800/60 font-medium">Shorthand</span>
                        <code class="bg-cyan-100 px-1.5 py-0.5 rounded text-cyan-900 font-mono">50k plus 10 thousand</code>
                    </div>
                </div>
            </div>
        </div>

        {# Group 3: Units & Conversions #}
        <div class="space-y-4">
            <div class="p-6 rounded-[2rem] bg-rose-50/50 border border-rose-100/50">
                <h3 class="text-sm font-bold text-rose-900 mb-3 flex items-center gap-2">
                    <span class="material-symbols-outlined text-base">straighten</span>
                    Units & Bases
                </h3>
                <div class="space-y-2">
                    <div class="flex items-center justify-between text-[11px]">
                        <span class="text-rose-800/60 font-medium">Length</span>
                        <code class="bg-rose-100 px-1.5 py-0.5 rounded text-rose-900 font-mono">5 km to m</code>
                    </div>
                    <div class="flex items-center justify-between text-[11px]">
                        <span class="text-rose-800/60 font-medium">Time</span>
                        <code class="bg-rose-100 px-1.5 py-0.5 rounded text-rose-900 font-mono">2h to mins</code>
                    </div>
                    <div class="flex items-center justify-between text-[11px]">
                        <span class="text-rose-800/60 font-medium">Binary</span>
                        <code class="bg-rose-100 px-1.5 py-0.5 rounded text-rose-900 font-mono">0b1010 to dec</code>
                    </div>
                    <div class="flex items-center justify-between text-[11px]">
                        <span class="text-rose-800/60 font-medium">Hex</span>
                        <code class="bg-rose-100 px-1.5 py-0.5 rounded text-rose-900 font-mono">0xff to dec</code>
                    </div>
                </div>
            </div>

            <div class="p-6 rounded-[2rem] bg-slate-50/50 border border-slate-100/50">
                <h3 class="text-sm font-bold text-slate-900 mb-3 flex items-center gap-2">
                    <span class="material-symbols-outlined text-base">calculate</span>
                    Advanced
                </h3>
                <div class="space-y-2">
                    <div class="flex items-center justify-between text-[11px]">
                        <span class="text-slate-800/60 font-medium">Percent of</span>
                        <code class="bg-slate-100 px-1.5 py-0.5 rounded text-slate-900 font-mono">20% of 500</code>
                    </div>
                    <div class="flex items-center justify-between text-[11px]">
                        <span class="text-slate-800/60 font-medium">Functions</span>
                        <code class="bg-slate-100 px-1.5 py-0.5 rounded text-slate-900 font-mono">f(x) = x^2</code>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    /* Math Notes line alignment */
    .math-input,
    .math-results {
        font-size: 15px;
        line-height: 28px;
        padding: 16px;
    }
    @media (min-width: 768px) {
        .math-input,
        .math-results {
            font-size: 20px;
            line-height: 40px;
            padding: 32px;
        }
    }
    .math-results {
        padding-left: 16px;
        padding-right: 16px;
    }
    .math-line {
        height: 28px;
        white-space: nowrap;
        display: block;
    }
    .math-results {
        direction: rtl;
    }
    .result-line {
        direction: ltr;
        text-align: right;
        width: max-content;
        min-width: 100%;
    }
    @media (min-width: 768px) {
        .math-line {
            height: 40px;
        }
    }

    .custom-scrollbar::-webkit-scrollbar {
        width: 6px;
        height: 6px;
    }
    .custom-scrollbar::-webkit-scrollbar-track {
        background: transparent;
    }
    .custom-scrollbar::-webkit-scrollbar-thumb {
        background: #333;
        border-radius: 10px;
    }
    .custom-scrollbar::-webkit-scrollbar-thumb:hover {
        background: #444;
    }

    /* Syntax Highlighting */
    .syntax-header { color: #818cf8; font-weight: bold; }
    .syntax-comment { color: #9ca3af; font-style: italic; }
    .syntax-variable { color: #fbbf24; }
    .syntax-assign { color: #e2e8f0; }
    .syntax-number { color: #84cc16; }
    .syntax-operator { color: #f43f5e; }
    .syntax-unit { color: #22d3ee; }
    .syntax-keyword { color: #c084fc; font-weight: 500; }

    .fullscreen-editor {
        --fullscreen-gap: clamp(16px, 3vw, 40px);
        position: fixed;
        inset: var(--fullscreen-gap);
        z-index: 50;
        width: calc(100vw - (var(--fullscreen-gap) * 2));
        height: calc(100vh - (var(--fullscreen-gap) * 2));
        border-radius: 40px;
        background-color: #0f0f0f;
        box-shadow: 0 30px 120px rgba(0, 0, 0, 0.65);
    }
    .fullscreen-editor textarea,
    .fullscreen-editor .math-input,
    .fullscreen-editor .math-results {
        min-height: 0 !important;
        height: 100% !important;
    }
    .fullscreen-editor textarea {
        padding-bottom: 32px;
    }
</style>

<script>
    function mathNotes() {
        return {
            input: '',
            results: [],
            scope: {},
            history: [],
            exporting: false,
            isFullscreen: false,
            resultsRatio: 0,

            get highlightedInput() {
                if (!this.input) return '';
                return this.input.split('\n').map(line => {
                    const highlighted = this.highlightLine(line);
                    return `<div class="math-line">${highlighted}</div>`;
                }).join('');
            },

            get resultsPaneStyles() {
                const ratio = this.resultsRatio || 0.22;
                const clamped = Math.min(Math.max(ratio, 0.15), 0.45);
                const percent = (clamped * 100).toFixed(2) + '%';
                return `flex: 0 0 ${percent}; width: ${percent}; max-width: ${percent};`;
            },

            init() {
                // Load from localStorage if available
                const saved = localStorage.getItem('math-notes-input');
                if (saved) {
                    this.input = saved;
                } else {
                    // Default example
                    this.input = '# Budget Example\n\nRent = 1500\nFood = 300\nUtilities = 150\nTotal = sum\n\n# Calculations\n100 + 15%\n5 km to meters';
                }
                this.calculate();
            },

            saveToStorage() {
                localStorage.setItem('math-notes-input', this.input);
            },

            toggleFullscreen() {
                if (!this.isFullscreen) {
                    this.resultsRatio = this.calculateResultsRatio();
                }
                this.isFullscreen = !this.isFullscreen;
                this.handleFullscreenSideEffects();
                if (this.isFullscreen && this.$refs.input) {
                    this.$nextTick(() => {
                        this.$refs.input.focus();
                    });
                }
            },

            exitFullscreen() {
                if (!this.isFullscreen) return;
                this.isFullscreen = false;
                this.handleFullscreenSideEffects();
            },

            handleFullscreenSideEffects() {
                document.body.classList.toggle('overflow-hidden', this.isFullscreen);
            },

            calculateResultsRatio() {
                if (!this.$refs.editor || !this.$refs.results) return 0.22;
                const editorRect = this.$refs.editor.getBoundingClientRect();
                const resultsRect = this.$refs.results.getBoundingClientRect();
                if (!editorRect.width) return 0.22;
                const ratio = resultsRect.width / editorRect.width;
                return Math.min(Math.max(ratio, 0.15), 0.45);
            },

            calculate() {
                const lines = this.input.split('\n');
                this.results = [];
                this.history = [];
                this.scope = {};

                // Basic static currency symbols for mapping (simple regex replacement)
                const currencyMap = {
                    '\\$': '', 
                    'EUR': '', 'â‚¬': '',
                    'USD': '',
                    'percent of': '*', // Handle "10% of 100" as "10% * 100"
                    ' of ': ' * '
                };

                // Natural language replacements
                const replacements = [
                    { reg: /\bplus\b/gi, sub: '+' },
                    { reg: /\bminus\b/gi, sub: '-' },
                    { reg: /\btimes\b|\bmultiplied by\b/gi, sub: '*' },
                    { reg: /\bdivided by\b/gi, sub: '/' },
                    { reg: /\bin decimal\b|\bto decimal\b/gi, sub: '' }, // mathjs handles 0x, 0b natively
                    { reg: /\bin hex\b|\bto hex\b/gi, sub: 'in hex' },
                    { reg: /\bin bin\b|\bto bin\b/gi, sub: 'in bin' },
                    // Scales
                    { reg: /\bthousand\b|\bk\b/gi, sub: '* 1000' },
                    { reg: /\bmillion\b|\bM\b/gi, sub: '* 1000000' },
                    { reg: /\bbillion\b/gi, sub: '* 1000000000' },
                ];

                lines.forEach((line, index) => {
                    let originalLine = line.trim();
                    let processedLine = originalLine;

                    // 1. Handle Headers - show header text on result panel
                    if (processedLine.startsWith('#')) {
                        const headerText = processedLine.slice(1).trim();
                        this.results.push({ 
                            text: headerText.toUpperCase(), 
                            isHeader: true 
                        });
                        this.history.push(null);
                        return;
                    }

                    // 2. Clear Comments (// or " ")
                    processedLine = processedLine.split('//')[0];
                    processedLine = processedLine.replace(/"[^"]*"/g, '');
                    
                    // 3. Handle Labels/Assignments for keyword detection
                    let assignVar = null;
                    let evalPart = processedLine;
                    if (processedLine.includes('=') && !processedLine.includes('==')) {
                        const parts = processedLine.split('=');
                        assignVar = parts[0].trim();
                        evalPart = parts.slice(1).join('=').trim();
                    } else if (processedLine.includes(':')) {
                        const parts = processedLine.split(':');
                        assignVar = parts[0].trim();
                        evalPart = parts.slice(1).join(':').trim();
                    }

                    if (!evalPart) {
                        this.results.push({ text: '', isHeader: false });
                        this.history.push(null);
                        return;
                    }

                    // 4. Handle multiline operators: prev, sum, total, average, avg
                    const lowerEval = evalPart.toLowerCase();
                    let customValue = null;

                    if (lowerEval === 'prev') {
                        customValue = this.getLastNumericResult();
                    } else if (lowerEval === 'sum') {
                        const segment = [];
                        for (let i = this.history.length - 1; i >= 0; i--) {
                            if (this.history[i] === null) break;
                            if (typeof this.history[i] === 'number') segment.push(this.history[i]);
                        }
                        if (segment.length > 0) customValue = segment.reduce((a, b) => a + b, 0);
                    } else if (lowerEval === 'avg' || lowerEval === 'average') {
                        const segment = [];
                        for (let i = this.history.length - 1; i >= 0; i--) {
                            if (this.history[i] === null) break;
                            if (typeof this.history[i] === 'number') segment.push(this.history[i]);
                        }
                        if (segment.length > 0) customValue = segment.reduce((a, b) => a + b, 0) / segment.length;
                    }

                    if (customValue !== null) {
                        if (assignVar) this.scope[assignVar] = customValue;
                        this.results.push({ text: this.formatResult(customValue), isHeader: false });
                        this.history.push(customValue);
                        return;
                    }

                    // 5. Apply Natural Language Replacements
                    replacements.forEach(r => {
                        evalPart = evalPart.replace(r.reg, r.sub);
                    });

                    // 6. Handle Currencies (Simple Mock)
                    Object.keys(currencyMap).forEach(key => {
                        evalPart = evalPart.replace(new RegExp(key, 'gi'), currencyMap[key]);
                    });

                    // Prepare full line for mathjs if it was an assignment
                    const finalEvalLine = assignVar ? `${assignVar} = ${evalPart}` : evalPart;

                    try {
                        const result = math.evaluate(finalEvalLine, this.scope);
                        
                        if (result === undefined || result === null) {
                            this.results.push({ text: '', isHeader: false });
                            this.history.push(null);
                        } else if (typeof result === 'function') {
                            // Only show result for function calls, not definitions
                            // math.evaluate returns a function object for definitions like f(x)=x^2
                            this.results.push({ text: '', isHeader: false });
                            this.history.push(null);
                        } else if (result && result.isUnit) {
                            this.results.push({ text: result.toString(), isHeader: false });
                            this.history.push(result.toNumber());
                        } else {
                            const val = typeof result === 'number' ? result : (result && typeof result.valueOf === 'function' ? result.valueOf() : null);
                            const formatted = this.formatResult(result);
                            this.results.push({ text: formatted, isHeader: false });
                            this.history.push(typeof val === 'number' ? val : null);
                        }
                    } catch (e) {
                        this.results.push({ text: '', isHeader: false });
                        this.history.push(null);
                    }
                });
            },

            getLastNumericResult() {
                for (let i = this.history.length - 1; i >= 0; i--) {
                    if (typeof this.history[i] === 'number') return this.history[i];
                }
                return 0;
            },

            formatResult(res) {
                if (typeof res === 'number') {
                    return res.toLocaleString(undefined, { maximumFractionDigits: 10 });
                }
                if (res && res.toString) return res.toString();
                return '';
            },

            syncScroll() {
                this.$refs.results.scrollTop = this.$refs.input.scrollTop;
                this.$refs.highlightLayer.scrollTop = this.$refs.input.scrollTop;
                this.$refs.highlightLayer.scrollLeft = this.$refs.input.scrollLeft;
            },

            highlightLine(line) {
                if (!line.trim()) return '&nbsp;';
                
                let escaped = line.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
                
                // 1. Header
                if (escaped.trim().startsWith('#')) {
                    return `<span class="syntax-header">${escaped}</span>`;
                }

                // 2. Comments
                let comment = '';
                if (escaped.includes('//')) {
                    const parts = escaped.split('//');
                    escaped = parts[0];
                    comment = `<span class="syntax-comment">//${parts.slice(1).join('//')}</span>`;
                }

                // 3. Variables & Assignment
                if (escaped.includes('=')) {
                    const parts = escaped.split('=');
                    const varPart = parts[0];
                    const valPart = parts.slice(1).join('=');
                    escaped = `<span class="syntax-variable">${varPart}</span><span class="syntax-assign">=</span>${this.highlightExpression(valPart)}`;
                } else if (escaped.includes(':')) {
                    // Handle labels like "Price: 100" as well
                    const parts = escaped.split(':');
                    const labelPart = parts[0];
                    const valPart = parts.slice(1).join(':');
                    escaped = `<span class="syntax-variable">${labelPart}</span><span class="syntax-assign">:</span>${this.highlightExpression(valPart)}`;
                } else {
                    escaped = this.highlightExpression(escaped);
                }

                return escaped + comment;
            },

            highlightExpression(expr) {
                // Keywords (sum, avg, to, of, etc.)
                const keywords = ['sum', 'avg', 'average', 'prev', 'to', 'of', 'plus', 'minus', 'times'];
                keywords.forEach(kw => {
                    const reg = new RegExp(`\\b${kw}\\b`, 'gi');
                    expr = expr.replace(reg, '<span class="syntax-keyword">$&</span>');
                });
                // Numbers (including percentages)
                expr = expr.replace(/(\b\d+(\.\d+)?%?)\b/g, '<span class="syntax-number">$1</span>');
                // Operators - only highlight + and *
                expr = expr.replace(/([+*])/g, '<span class="syntax-operator">$1</span>');
                // Units
                const units = ['km', 'cm', 'mm', 'meters', 'kg', 'hr', 'min', 'usd', 'eur'];
                units.forEach(u => {
                    const reg = new RegExp(`\\b${u}\\b`, 'gi');
                    expr = expr.replace(reg, '<span class="syntax-unit">$&</span>');
                });
                return expr;
            },

            clearAll() {
                this.input = '';
                this.saveToStorage();
                this.results = [];
                this.history = [];
                this.scope = {};
                this.$refs.input.focus();
            },

            exportInputs() {
                if (!this.input) return;
                this.downloadFile(this.input, `math-notes-input-${Date.now()}.txt`);
            },

            exportResults() {
                const text = this.results.map(r => r.text).filter(t => t !== '').join('\n');
                if (!text) return;
                this.downloadFile(text, `math-notes-results-${Date.now()}.txt`);
            },

            async exportImage() {
                const editor = this.$refs.editor;
                const input = this.$refs.input;
                const highlightLayer = this.$refs.highlightLayer;

                this.exporting = true;
                // Swap textarea visibility for high-quality render
                input.style.opacity = '0';
                highlightLayer.style.color = '#fff'; // Make it visible for capture
                highlightLayer.style.textShadow = 'none';

                await this.$nextTick();

                try {
                    const canvas = await html2canvas(editor, {
                        backgroundColor: '#1e1e1e',
                        scale: 2,
                        logging: false,
                        useCORS: true
                    });
                    
                    const link = document.createElement('a');
                    link.download = `math-notes-${Date.now()}.png`;
                    link.href = canvas.toDataURL('image/png');
                    link.click();
                } catch (e) {
                    console.error('Export Image Error:', e);
                    alert('Failed to export image.');
                } finally {
                    this.exporting = false;
                    input.style.opacity = '1';
                    highlightLayer.style.color = 'transparent';
                }
            },

            downloadFile(content, filename) {
                const blob = new Blob([content], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = filename;
                link.click();
                URL.revokeObjectURL(url);
            }
        }
    }
</script>
