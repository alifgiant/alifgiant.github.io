---
layout: layouts/base.njk
title: Geo Tool
description: Digitize buildings, measure polygon areas, and manage KML/Shapefile data with high-res satellite views.
permalink: /tools/kml-viewer/
---

{# Leaflet CSS #}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
{# Leaflet JS #}
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
{# Turf.js for area calculation #}
<script src="https://unpkg.com/@turf/turf@6/turf.min.js"></script>
{# Geoman JS & CSS #}
<link rel="stylesheet" href="https://unpkg.com/@geoman-io/leaflet-geoman-free@latest/dist/leaflet-geoman.css" />
<script src="https://unpkg.com/@geoman-io/leaflet-geoman-free@latest/dist/leaflet-geoman.js"></script>
{# togeojson JS #}
<script src="https://unpkg.com/@tmcw/togeojson@5.0.0/dist/togeojson.umd.js"></script>
{# shp-write JS #}
<script src="https://unpkg.com/shp-write@0.4.0/shpwrite.js"></script>
{# JSZip for KMZ support #}
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

<div class="w-full max-w-5xl flex flex-col gap-12" x-data="kmlViewer()">
    {# Header #}
    {% set tool = {} %}
    {% for item in site.pages.tools.list %}
        {% if item.url == "/tools/kml-viewer/" %}
            {% set tool = item %}
        {% endif %}
    {% endfor %}
    {% set cat = site.pages.tools.categories[tool.tag] %}
    
    <div class="flex flex-col gap-4 text-center items-center">
        <div class="inline-flex items-center gap-2 px-3 py-1 rounded-full text-xs font-bold uppercase tracking-wider border {{ cat.color }}">
            <span class="material-symbols-outlined text-sm">{{ cat.icon }}</span>
            {{ tool.tag }}
        </div>
        <div class="w-16 h-16 rounded-2xl {{ cat.lightColor }} flex items-center justify-center mb-2">
            <span class="material-symbols-outlined text-4xl">{{ tool.icon }}</span>
        </div>
        <h1 class="text-4xl md:text-6xl font-bold text-text-main font-display">
            {{ tool.title }}
        </h1>
        <p class="text-lg text-text-muted max-w-2xl leading-relaxed">
            {{ tool.description }}
        </p>
    </div>

    {# Onboarding Selection (Initial State) #}
    <div x-show="onboarding" class="grid grid-cols-1 md:grid-cols-2 gap-8 animate-fade-in" x-cloak>
        <button @click="startDrawing()" class="group bg-white border-2 border-dashed border-stone-200 rounded-[2.5rem] p-12 hover:border-indigo-400 hover:bg-indigo-50/30 transition-all duration-500 flex flex-col items-center gap-6 text-center">
            <div class="w-20 h-20 rounded-3xl bg-indigo-50 text-indigo-500 flex items-center justify-center group-hover:scale-110 transition-transform">
                <span class="material-symbols-outlined text-5xl">edit_square</span>
            </div>
            <div>
                <h3 class="text-2xl font-bold text-text-main mb-2">Draw Building</h3>
                <p class="text-sm text-text-muted">Start marking structures directly on high-resolution satellite maps.</p>
            </div>
        </button>
        
        <div @dragover.prevent="dragOver = true" 
             @dragleave.prevent="dragOver = false" 
             @drop.prevent="handleDrop($event)"
             :class="dragOver ? 'border-emerald-400 bg-emerald-50/50 scale-[1.02]' : 'border-stone-200 bg-white'"
             class="group relative border-2 border-dashed rounded-[2.5rem] p-12 hover:border-emerald-400 hover:bg-emerald-50/30 transition-all duration-500 flex flex-col items-center gap-6 text-center cursor-pointer">
            <input type="file" accept=".kml,.kmz,.xml" class="absolute inset-0 opacity-0 cursor-pointer" @change="handleFileSelect($event)">
            <div class="w-20 h-20 rounded-3xl bg-emerald-50 text-emerald-500 flex items-center justify-center group-hover:scale-110 transition-transform">
                <span class="material-symbols-outlined text-5xl">upload_file</span>
            </div>
            <div>
                <h3 class="text-2xl font-bold text-text-main mb-2">Upload KML / KMZ</h3>
                <p class="text-sm text-text-muted">Import existing KML or KMZ files to view, measure, and edit on the map.</p>
            </div>
        </div>
    </div>

    {# Main Tool Content (Map & Sidebar) #}
    <div x-show="!onboarding" class="grid grid-cols-1 lg:grid-cols-12 gap-8 items-start animate-fade-in" x-cloak>
        {# Sidebar #}
        <div class="lg:col-span-4 flex flex-col gap-6">
            <div class="bg-white/80 backdrop-blur-md border border-white rounded-[2rem] p-8 shadow-xl shadow-primary/5">
                <div class="flex items-center justify-between mb-6">
                    <h3 class="text-sm font-bold text-text-main flex items-center gap-2 uppercase tracking-widest">
                        <span class="material-symbols-outlined text-indigo-500 text-lg">layers</span>
                        Project Data
                    </h3>
                </div>

                {# Empty State if no data but drawing #}
                <div x-show="!fileName && featuresCount === 0" class="p-4 bg-stone-50 border border-stone-100 rounded-2xl text-center">
                    <p class="text-[10px] text-text-muted font-bold uppercase tracking-wider">Drawing mode active</p>
                    <p class="text-[9px] text-text-muted mt-1 leading-relaxed">Start drawing on the map to see your features here.</p>
                </div>

                {# File Info / Status #}
                <template x-if="fileName">
                    <div class="p-4 bg-emerald-50/50 border border-emerald-100 rounded-2xl">
                        <div class="flex items-center gap-3">
                            <span class="material-symbols-outlined text-emerald-500">check_circle</span>
                            <div class="min-w-0">
                                <p class="text-xs font-bold text-text-main truncate" x-text="fileName"></p>
                                <p class="text-[10px] text-emerald-600 font-medium" x-text="featuresCount + ' features found'"></p>
                            </div>
                        </div>
                    </div>
                </template>

                {# Actions #}
                <div class="mt-8 flex flex-col gap-3">
                    <button @click="downloadSHP()" class="flex items-center justify-center gap-2 w-full py-4 bg-indigo-600 text-white rounded-2xl font-bold text-sm hover:bg-indigo-700 transition-all shadow-lg shadow-indigo-200 active:scale-[0.98]">
                        Download SHP (ZIP)
                        <span class="material-symbols-outlined text-lg">download</span>
                    </button>
                    <button @click="downloadGeoJSON()" class="flex items-center justify-center gap-2 w-full py-4 bg-stone-800 text-white rounded-2xl font-bold text-sm hover:bg-stone-900 transition-all active:scale-[0.98]">
                        Download GeoJSON
                        <span class="material-symbols-outlined text-lg">code</span>
                    </button>
                    <button @click="reset()" class="flex items-center justify-center gap-2 w-full py-2 text-rose-500 text-[10px] font-bold uppercase tracking-widest hover:text-rose-600 transition-colors">
                        New Project (Reset)
                        <span class="material-symbols-outlined text-sm">delete</span>
                    </button>
                </div>
            </div>

            <div class="bg-indigo-50/30 rounded-3xl p-6 border border-indigo-100/50 flex flex-col gap-3">
                <div class="flex items-center gap-2 text-indigo-600 font-bold text-xs uppercase tracking-widest">
                    <span class="material-symbols-outlined text-lg">square_foot</span>
                    Area Measurement
                </div>
                <p class="text-[11px] text-text-muted leading-relaxed italic">
                    Any polygon you draw will show its calculated area in real-time. Use the **Satellite (Hybrid)** layer for the most up-to-date building footprints.
                </p>
            </div>
            
            <div class="bg-indigo-50/30 rounded-3xl p-6 border border-indigo-100/50 flex flex-col gap-3">
                <div class="flex items-center gap-2 text-indigo-600 font-bold text-xs uppercase tracking-widest">
                    <span class="material-symbols-outlined text-lg">info</span>
                    Privacy Note
                </div>
                <p class="text-[11px] text-text-muted leading-relaxed italic">
                    All processing is local. Your location and data never leave your browser. Large datasets remain private on your device.
                </p>
            </div>
        </div>

        {# Map Container #}
        <div class="lg:col-span-8 h-[650px] bg-stone-100 rounded-[2.5rem] overflow-hidden border border-stone-200 shadow-2xl relative z-0">
            <div id="map" class="w-full h-full"></div>
        </div>
    </div>

    {# Back Button #}
    <div class="flex justify-center">
        <a href="/tools/" class="flex items-center gap-2 text-text-muted hover:text-primary transition-colors font-bold uppercase tracking-widest text-xs">
            <span class="material-symbols-outlined text-sm">arrow_back</span>
            Back to Tools
        </a>
    </div>
</div>

<script>
    function kmlViewer() {
        return {
            map: null,
            layer: null,
            geoJsonData: null,
            fileName: '',
            featuresCount: 0,
            dragOver: false,
            onboarding: true,

            init() {
                this.$nextTick(() => {
                    this.initMap();
                });
            },

            initMap() {
                if (this.map) return;
                
                // Base Layers
                const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '&copy; OpenStreetMap contributors'
                });

                const satelliteEsri = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                    attribution: 'Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EBP, and the GIS User Community'
                });

                // Google Satellite (Hybrid)
                const googleHybrid = L.tileLayer('https://mt1.google.com/vt/lyrs=y&x={x}&y={y}&z={z}', {
                    attribution: '&copy; Google'
                });

                // Initialize map
                this.map = L.map('map', {
                    layers: [osm]
                }).setView([-3.3199, 114.5908], 17); // Initial view: Banjarmasin city center
                
                // Layer controls
                const baseMaps = {
                    "Street Map": osm,
                    "Satellite (ESRI)": satelliteEsri,
                    "Satellite (Hybrid)": googleHybrid
                };
                
                L.control.layers(baseMaps).addTo(this.map);
                L.control.scale().addTo(this.map);

                // Initialize Geoman
                this.map.pm.addControls({
                    position: 'topleft',
                    drawMarker: true,
                    drawPolyline: true,
                    drawRectangle: true,
                    drawPolygon: true,
                    drawCircle: false,
                    drawCircleMarker: false,
                    editMode: true,
                    dragMode: true,
                    cutPolygon: true,
                    removalMode: true,
                });

                // Customize Geoman style
                this.map.pm.setGlobalOptions({ 
                    pathOptions: {
                        color: '#4f46e5',
                        weight: 4,
                        fillColor: '#4f46e5',
                        fillOpacity: 0.25,
                        opacity: 0.9
                    },
                    templineStyle: {
                        color: '#4f46e5',
                    },
                    hintlineStyle: {
                        color: '#4f46e5',
                        dashArray: [5, 5],
                    }
                });

                // Area Measurement Binding
                this.map.on('pm:create', (e) => {
                    if (e.shape === 'Polygon' || e.shape === 'Rectangle') {
                        this.updateArea(e.layer);
                        e.layer.on('pm:edit', () => this.updateArea(e.layer));
                    }
                    this.featuresCount++;
                });

                this.map.on('pm:remove', () => {
                    this.featuresCount--;
                });
            },

            updateArea(layer) {
                const geojson = layer.toGeoJSON();
                const area = turf.area(geojson);
                let displayText = '';
                
                if (area < 10000) {
                    displayText = `${area.toFixed(2)} m²`;
                } else {
                    displayText = `${(area / 1000000).toFixed(4)} km²`;
                }

                layer.bindTooltip(`Area: ${displayText}`, {
                    permanent: true,
                    direction: 'top',
                    offset: [0, -10],
                    className: 'area-tooltip',
                    interactive: false
                }).openTooltip();
            },

            startDrawing() {
                this.onboarding = false;
                // Ensure map is properly sized after showing
                this.$nextTick(() => {
                    this.map.invalidateSize();
                    this.map.pm.enableDraw('Polygon');
                });
            },

            handleFileSelect(e) {
                const file = e.target.files[0];
                if (file) {
                    this.onboarding = false;
                    this.processFile(file);
                }
                e.target.value = '';
            },

            handleDrop(e) {
                this.dragOver = false;
                const file = e.dataTransfer.files[0];
                if (file) {
                    this.onboarding = false;
                    this.processFile(file);
                }
            },

            async processFile(file) {
                const name = file.name.toLowerCase();
                const isKml = name.endsWith('.kml');
                const isKmz = name.endsWith('.kmz');
                const isXml = name.endsWith('.xml');

                if (!isKml && !isKmz && !isXml) {
                    alert('Please upload a valid .kml, .kmz, or .xml file');
                    return;
                }

                this.onboarding = false;
                this.fileName = file.name;
                
                // Ensure map is visible before starting heavy processing
                await this.$nextTick();
                this.map.invalidateSize();

                try {
                    let text;
                    if (isKmz) {
                        const zip = await JSZip.loadAsync(file);
                        const kmlFile = Object.values(zip.files).find(f => f.name.toLowerCase().endsWith('.kml'));
                        if (!kmlFile) throw new Error('No KML file found inside KMZ');
                        text = await kmlFile.async('string');
                    } else {
                        text = await file.text();
                    }

                    const parser = new DOMParser();
                    const doc = parser.parseFromString(text, 'text/xml');
                    
                    const parserError = doc.querySelector('parsererror');
                    if (parserError) throw new Error('Invalid XML structure in KML/XML file');

                    const geojson = toGeoJSON.kml(doc);
                    if (!geojson || !geojson.features || geojson.features.length === 0) {
                        throw new Error('This file contains no valid geographic features');
                    }

                    this.geoJsonData = geojson;
                    this.featuresCount = geojson.features.length;

                    // Final check for map size before rendering
                    this.map.invalidateSize();
                    this.renderGeoJSON(geojson);
                } catch (error) {
                    console.error('Mapper Error:', error);
                    alert(`Error parsing file: ${error.message}. Please ensure it is a valid KML/KMZ.`);
                    this.onboarding = true;
                }
            },

            renderGeoJSON(geojson) {
                if (this.layer) {
                    this.map.removeLayer(this.layer);
                }

                this.layer = L.geoJSON(geojson, {
                    style: (feature) => {
                        return {
                            color: '#4f46e5',
                            weight: 4,
                            opacity: 0.9,
                            fillColor: '#4f46e5',
                            fillOpacity: 0.25
                        };
                    },
                    onEachFeature: (feature, layer) => {
                        if (feature.geometry.type === 'Polygon' || feature.geometry.type === 'MultiPolygon') {
                            this.updateArea(layer);
                        }

                        if (feature.properties) {
                            let popupContent = '<div class="p-2 space-y-1">';
                            for (let key in feature.properties) {
                                if (key !== 'styleUrl' && key !== 'styleHash' && key !== 'styleMapHash') {
                                    popupContent += `<p class="text-[10px]"><strong class="font-bold">${key}:</strong> ${feature.properties[key]}</p>`;
                                }
                            }
                            popupContent += '</div>';
                            layer.bindPopup(popupContent);
                        }
                        
                        // Ensure layer is actually visible/stylable
                        if (layer.setStyle) {
                            layer.setStyle({
                                color: '#4f46e5',
                                weight: 4,
                                opacity: 0.9,
                                fillColor: '#4f46e5',
                                fillOpacity: 0.25
                            });
                        }
                    }
                }).addTo(this.map);

                // Ensure the map container is ready for bounds fitting
                this.$nextTick(() => {
                    this.map.invalidateSize();
                    const bounds = this.layer.getBounds();
                    if (bounds.isValid()) {
                        this.map.fitBounds(bounds, { padding: [50, 50], animate: true });
                    }
                });
            },

            getAllFeaturesAsGeoJSON() {
                const features = [];
                
                // 1. From uploaded KML layer
                if (this.layer) {
                    this.layer.eachLayer(l => {
                        if (typeof l.toGeoJSON === 'function') {
                            features.push(l.toGeoJSON());
                        }
                    });
                }

                // 2. From Geoman drawn layers
                this.map.eachLayer(l => {
                    if (l instanceof L.Path || l instanceof L.Marker) {
                        if (l.pm && !this.layer?.hasLayer(l)) {
                             features.push(l.toGeoJSON());
                        }
                    }
                });

                return {
                    type: "FeatureCollection",
                    features: features
                };
            },

            downloadGeoJSON() {
                const combinedData = this.getAllFeaturesAsGeoJSON();
                if (combinedData.features.length === 0) {
                    alert('No features to export. Upload a KML or draw on the map.');
                    return;
                }

                const blob = new Blob([JSON.stringify(combinedData, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = (this.fileName || 'export').replace('.kml', '') + '_mapper.geojson';
                link.click();
                URL.revokeObjectURL(url);
            },

            downloadSHP() {
                const combinedData = this.getAllFeaturesAsGeoJSON();
                if (combinedData.features.length === 0) {
                    alert('No features to export. Upload a KML or draw on the map.');
                    return;
                }
                
                try {
                    shpwrite.download(combinedData, {
                        folder: (this.fileName || 'export').replace('.kml', '') + '_shp',
                        types: {
                            point: 'points',
                            polygon: 'polygons',
                            line: 'lines'
                        }
                    });
                } catch (error) {
                    console.error('Error generating Shapefile:', error);
                    alert('Error generating Shapefile. Note: Complex geometries might require GeoJSON export instead.');
                }
            },

            reset() {
                if (this.layer) {
                    this.map.removeLayer(this.layer);
                    this.layer = null;
                }
                
                this.map.eachLayer(l => {
                    if (l.pm && !l._url) {
                        this.map.removeLayer(l);
                    }
                });

                this.geoJsonData = null;
                this.fileName = '';
                this.featuresCount = 0;
                this.onboarding = true;
                this.map.setView([-3.3199, 114.5908], 17);
            }
        }
    }
</script>

<style>
    /* Fix Leaflet pointer issues in some environments */
    .leaflet-container {
        cursor: crosshair !important;
    }
    .leaflet-popup-content-wrapper {
        border-radius: 1rem !important;
        box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1) !important;
    }
    .leaflet-popup-content {
        margin: 12px 16px !important;
    }
    /* Tooltip styling */
    .area-tooltip {
        background: rgba(79, 70, 229, 0.9) !important;
        border: none !important;
        border-radius: 8px !important;
        color: white !important;
        font-weight: 800 !important;
        font-size: 10px !important;
        box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1) !important;
        padding: 4px 8px !important;
        backdrop-filter: blur(4px) !important;
    }
    .area-tooltip::before {
        border-top-color: rgba(79, 70, 229, 0.9) !important;
    }
</style>
